<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë£¨ë£¨ë´‡ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="dashboard">
      <!-- ì‚¬ì´ë“œë°” -->
      <aside class="sidebar">
        <h2>LULUBOT</h2>
        <ul>
          <li class="active">ëŒ€ì‹œë³´ë“œ</li>
          <li>ê°ì • ë¶„ì„</li>
          <li>ì„±ê²© íŠ¹ì„±</li>
          <li>ëŒ€í™” ê¸°ë¡</li>
          <li>ì„¤ì •</li>
        </ul>
        <div class="version">v1.2.3</div>
      </aside>

      <!-- ì½˜í…ì¸  -->
      <main class="content">
        <header>
          <h1>ë£¨ë£¨ë´‡ ëŒ€ì‹œë³´ë“œ</h1>
          <div class="user">ê´€ë¦¬ì</div>
        </header>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <section class="page" id="dashboardPage" style="display: block;">
          <!-- <section class="cards">
            <div class="card">
              <h3>ğŸ˜Š í˜„ì¬ ê°ì •</h3><p>
                í–‰ë³µ<br /><span class="small">3ì‹œê°„ ì—°ì† ìœ ì§€</span>
              </p>
            </div>
            <div class="card">
              <h3>ğŸ’¬ ì˜¤ëŠ˜ì˜ ëŒ€í™”</h3><p>
                24<br /><span class="small">ì–´ì œë³´ë‹¤ +5</span>
              </p>
            </div>
            <div class="card">
              <h3>ğŸ¯ ì–¼êµ´ ì¸ì‹ ì •í™•ë„</h3><p>
                98%<br /><span class="small">ì§€ë‚œì£¼ë³´ë‹¤ +2%</span>
              </p>
            </div>
            <div class="card">
              <h3>ğŸ”‹ ë°°í„°ë¦¬ ìƒíƒœ</h3><p>
                78%<br /><span class="small">ì•½ 5ì‹œê°„ ë‚¨ìŒ</span>
              </p>
            </div>
          </section>

          <section class="charts">
            <div class="chart-box">
              <h3>ìµœê·¼ ê°ì • ì¶”ì´</h3>
              <canvas id="emotionTrend"></canvas>
            </div>
            <div class="chart-box">
              <h3>ì„±ê²© íŠ¹ì„±</h3>
              <canvas id="personalityChart"></canvas>
            </div>
          </section> -->
        </section>

        <section class="cards" id="cardContainer"></section>

        <!-- ê°ì • ë¶„ì„ -->
        <section class="page" id="emotionPage" style="display: none;">
          <h3>ì‹¤ì‹œê°„ ê°ì • ë¶„ì„</h3>
          <video id="video" width="400" autoplay playsinline></video><br />
          <button id="captureBtn" onclick="capture()" disabled>ë£¨ë£¨ë´‡ì—ê²Œ ê°ì • ë³´ì—¬ì£¼ê¸°</button><br />
          <img id="photo" /><br />
          <p id="response"></p>
          <canvas id="emotionChart"></canvas>
        </section>

        <!-- ì„±ê²© íŠ¹ì„± -->
        <section class="page" id="personalityPage" style="display: none;">
          <h3>ì„±ê²© íŠ¹ì„± ë¶„ì„ ê²°ê³¼</h3>
          <canvas id="personalityChart" style="max-width: 400px; width: 100%; height: auto;"></canvas>
        </section>

        <!-- ëŒ€í™” ê¸°ë¡ -->
        <section class="page" id="chatLogPage" style="display: none;">
          <h3>ìµœê·¼ ëŒ€í™”</h3>
          <table>
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>ì§ˆë¬¸</th>
                <th>ì‘ë‹µ</th>
                <th>ê°ì •</th>
              </tr>
            </thead>
            <tbody id="logTableBody">
              <!-- JSì—ì„œ ìë™ ì¶”ê°€ -->
            </tbody>
          </table>
        </section>

        <!-- ëŒ€í™” ì‹œì‘ -->
        <div class="chat-input">
          <input type="text" id="userMessage" placeholder="ë£¨ë£¨ë´‡ì—ê²Œ ë§ ê±¸ê¸°..." />
          <button onclick="sendUserMessage()">ì „ì†¡</button>
        </div>

        <!-- ì„¤ì • -->
        <section class="page" id="settingsPage" style="display: none;">
          <h3>ì„¤ì •</h3>
          <label><input type="checkbox" checked />ìë™ ê°ì • ë¶„ì„ í™œì„±í™”</label>
        </section>
      </main>
    </div>

    <!-- JS ì‚½ì… -->
    <script>
      // í˜ì´ì§€ ì „í™˜
      document.addEventListener('DOMContentLoaded', () => {
        const menuItems = document.querySelectorAll('.sidebar li')
        const pages = document.querySelectorAll('.page')
        const pageIds = ['dashboardPage', 'emotionPage', 'personalityPage', 'chatLogPage', 'settingsPage']
      
        menuItems.forEach((item, index) => {
          item.addEventListener('click', () => {
            pages.forEach((p) => (p.style.display = 'none'))
            document.getElementById(pageIds[index]).style.display = 'block'
      
            menuItems.forEach((i) => i.classList.remove('active'))
            item.classList.add('active')
          })
        })
      
        // ì„±ê²© íŠ¹ì„± ì°¨íŠ¸
        const ctx = document.getElementById('personalityChart').getContext('2d')
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['ì™¸í–¥ì„±', 'ì¹œí™”ì„±', 'ì„±ì‹¤ì„±', 'ê°ì • ì•ˆì •ì„±', 'ê°œë°©ì„±'],
            datasets: [
              {
                label: 'ë£¨ë£¨ë´‡ ì„±ê²© ì ìˆ˜',
                data: [72, 88, 67, 53, 81],
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100
              }
            }
          }
        })
      })
      
      // ì›¹ìº  ì—°ë™
      navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
        const video = document.getElementById('video')
        video.srcObject = stream
        video.onloadedmetadata = () => {
          document.getElementById('captureBtn').disabled = false
        }
      })
      
      // ìº¡ì²˜ ë° ë¶„ì„
      function capture() {
        const video = document.getElementById('video')
        if (video.videoWidth === 0 || video.videoHeight === 0) {
          alert('ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')
          return
        }
      
        const canvas = document.createElement('canvas')
        canvas.width = video.videoWidth
        canvas.height = video.videoHeight
        canvas.getContext('2d').drawImage(video, 0, 0)
        const dataUrl = canvas.toDataURL('image/jpeg')
        document.getElementById('photo').src = dataUrl
      
        fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: dataUrl })
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              alert(data.error)
              return
            }
      
            document.getElementById('response').innerText = data.response
      
            // ê°ì • ì°¨íŠ¸
            const ctx = document.getElementById('emotionChart').getContext('2d')
            const labels = Object.keys(data.emotions)
            const values = Object.values(data.emotions)
      
            if (window.emotionChart) window.emotionChart.destroy()
            window.emotionChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'ê°ì • í™•ë¥  (%)',
                    data: values,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                  }
                ]
              },
              options: {
                scales: {
                  y: { beginAtZero: true, max: 100 }
                }
              }
            })
      
            // ëŒ€í™” ê¸°ë¡ ì¶”ê°€
            const logTable = document.getElementById('logTableBody')
            const row = document.createElement('tr')
            row.innerHTML = `
                      <td>${new Date().toLocaleTimeString()}</td>
                      <td>-</td>
                      <td>${data.response}</td>
                      <td>${data.dominant}</td>
                    `
            logTable.appendChild(row)
          })
      }
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  </body>
</html>
